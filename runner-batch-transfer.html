<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <base href="/" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="apple-touch-icon" href="/logo192.png" />
    <link rel="manifest" href="/manifest.json" />

    <title>Ticket Runner</title>
    <meta name="description" content="Batch transfer NFTs on BNB Chain" />
  </head>
  <body class="text-light vstack h-100 lead" style="background-color:#222">
    <main role="main" class="row w-50 mx-auto" style="margin:4em 0">
      <h1>Ticket Runner</h1>
      <p class="mb-5">Quickly send multiple tickets to another address in one single transaction. Save on gas and time.</p>

        <div class="mb-3" style="display:none">
            <label for="network" class="form-label">Network</label>
            <select class="form-select" id="network">
              <option value="bnbmainnet">BNB Chain</option>
              <option selected value="bnbtestnet">BNB Chain Testnet</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="contract" class="form-label">What are you sending?</label>
            <select class="form-select" id="contract">
              <option selected value="0x6f582da4B59659114316B5CEc8A58b81AC21827a">Sweet Stacks Testnet</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="recipient" class="form-label">Recipient address&nbsp;
              <span style="font-size:smaller">0xc6Dc34460a78ac388EA2F7F4dFFA3dDE7591837e</span>
            </label>
            <input class="form-control" id="recipient" placeholder="0x...">
        </div>
        <div class="mb-3">
            <label for="tokenids" class="form-label">Token IDs (one per line)</label>
            <textarea class="form-control" id="tokenids" rows="3"></textarea>
        </div>
        <div id="feedback" class="mb-3">feedback</div>
        <div class="hstack gap-3 mb-3" style="display:block">
          <button id="btn-connect" class="btn btn-lg btn-secondary" style="width:100%;">Connect Wallet</button>
          <button id="btn-approve" class="btn btn-lg btn-primary" style="width:100%;display:none">Approve Contract</button>
          <button id="btn-transfer" class="btn btn-lg btn-primary" style="width:100%;display:none">Transfer</button>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.4.6/dist/ethers.umd.min.js" integrity="sha256-hhyZwmdi3z8gOlk+hH86uTyHPFbQQ4j9JGWW/pE+kks=" crossorigin="anonymous"></script>
    <script>
      const transferContractAddressPerNetwork = {
        bnbmainnet: "0xA65e0758d3Cc157f2020Deb34fDB88690743b847",
        bnbtestnet: "0xD834cd2CcB6646eFeD7E3eF70C26Df65F79069eC"
      }
      const transferContractAbi = [
        "function batchTransfer(address tokenContract, address recipient, uint256[] calldata tokenIds)"
      ];

      const erc721abi = [
        "function setApprovalForAll(address operator, bool approved)",
        "function isApprovedForAll(address owner, address operator) view returns (bool)"
      ];

      document.getElementById("btn-connect").addEventListener("click", async function() {
        await ethereum.request({ method: "eth_requestAccounts" });
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();

        const network = document.getElementById("network").value;
        if (typeof transferContractAddressPerNetwork[network] === "undefined") {
          return document.getElementById("feedback").innerHTML = "Please pick a network.";
        }
        const transferContractAddress = transferContractAddressPerNetwork[network];
        const erc721ContractAddress = document.getElementById("contract").value;
        if (erc721ContractAddress.length !== 42) {
          return document.getElementById("feedback").innerHTML = "Please fill in contract address for ERC-721 token contract.";
        }
        // Check approval & display Transfer btn if pre-approved
        const erc721Contract = new ethers.Contract(erc721ContractAddress, erc721abi, provider);
        const isAlreadyApproved = await erc721Contract.isApprovedForAll(await signer.getAddress(), transferContractAddress);
        if (isAlreadyApproved) {
          var btnConnect = document.getElementById("btn-connect");
          btnConnect.style.display = 'none';
          var btnTransfer = document.getElementById("btn-transfer");
          btnTransfer.style.display = 'block';
          return console.log ("Contract already approved. Ready to transfer.");
        }
          // Show Approve btn
          var btnConnect = document.getElementById("btn-connect");
          btnConnect.style.display = 'none';
          var btnApprove = document.getElementById("btn-approve");
          btnApprove.style.display = 'block';
          btnApprove.addEventListener("click", async function() {
            const erc721ContractWithSigner = erc721Contract.connect(signer);
            await erc721ContractWithSigner.setApprovalForAll(transferContractAddress, true);
        });
      });

      document.getElementById("btn-transfer").addEventListener("click", async function() {
          await ethereum.request({ method: "eth_requestAccounts" });
          const provider = new ethers.providers.Web3Provider(window.ethereum);
          const signer = provider.getSigner();

        const network = document.getElementById("network").value;
        if (typeof transferContractAddressPerNetwork[network] === "undefined") {
          return alert("Please pick a network.");
        }
        const transferContractAddress = transferContractAddressPerNetwork[network];
        const erc721ContractAddress = document.getElementById("contract").value;
        if (erc721ContractAddress.length !== 42) {
         return document.getElementById("feedback").innerHTML = "Please fill in contract address for ERC-721 token contract.";
        }
        const recipientAddress = document.getElementById("recipient").value;
        if (recipientAddress.length !== 42) {
          return document.getElementById("feedback").innerHTML = "Please fill in token recipient address.";
        }
        if (erc721ContractAddress === recipientAddress) {
          return document.getElementById("feedback").innerHTML = "Stop! You are about to send tokens to the contract address.";
        }
        const erc721Contract = new ethers.Contract(erc721ContractAddress, erc721abi, provider);
        const isAlreadyApproved = await erc721Contract.isApprovedForAll(await signer.getAddress(), transferContractAddress);
        if (!isAlreadyApproved) {
          return document.getElementById("feedback").innerHTML = "You did not approve contract for batch transfer yet. Please do that first. Aborted batch transfer.";
        }
        const tokenIds = document.getElementById("tokenids").value.trim().split(/\s+/);
        if (tokenIds.length === 0 || (tokenIds.length === 1 && tokenIds[0] === '')) {
          return document.getElementById("feedback").innerHTML = "Please enter token IDs to transfer.";
        }
        for (let i = 0; i < tokenIds.length; i++) {
          if (!tokenIds[i].match(/^\d+$/)) {
            return alert("Token IDs must be decimal numbers. Your token in position " + i + " was " + tokenIds[i]);
          }
        }
        const tokenIdsBigNumbers = tokenIds.map(x => ethers.BigNumber.from(x));

        const transferContract = new ethers.Contract(transferContractAddress, transferContractAbi, provider);
        const transferContractWithSigner = transferContract.connect(signer);
        await transferContractWithSigner.batchTransfer(erc721ContractAddress, recipientAddress, tokenIds);

      });
    </script>  
  </body>
</html>


<!--
document.getElementById("btnapprove").disabled = true;

document.getElementById("btnapprove").className += " " + "toApprove";

document.getElementById("btnapprove").setAttribute("onclick","goApprove");

document.getElementById("btnapprove").setAttribute("data-user", "poppy");
document.querySelector("[data-user='poppy']");



    const isreadytoApprove = await erc721Contract.isApprovedForAll(await signer.getAddress(), transferContractAddress);
      if (isreadytoApprove) {
        var btnChange = document.getElementById("btnapprove");
        btnChange.innerHTML = "Transfer";
        btnChange.className += " " + "approved";
        return console.log ("Contract already approved. Aborting. Ready to transfer.");
      }
      const erc721ContractWithSigner = erc721Contract.connect(signer);
      await erc721ContractWithSigner.setApprovalForAll(transferContractAddress, true);



    function goApprove() {
        await erc721Contract.isApprovedForAll(await signer.getAddress(), transferContractAddress);
        const erc721ContractWithSigner = erc721Contract.connect(signer);
        await erc721ContractWithSigner.setApprovalForAll(transferContractAddress, true);
        btnChange.removeAttribute("onclick","goApprove");
    }

-->